/*!
 * MicroVal jQuery plugin v2.4
 * http://bitbucket.org/rushtheweb/microval/
 * Copyright 2011-2012, Michael Gunderson - RushTheWeb.com
 * Dual licensed under the MIT or GPL Version 2 licenses. Same as jQuery.
 */
(function(a){a.fn.microval=function(l){var f=a.extend(true,{rules:{required:{validate:function(){return(this.is("[type=checkbox],[type=radio]")?this.is(":checked"):(a.trim(this.val()).length>0))},message:"Required"},length:{validate:function(w){var v=true,o=(this.val()).length;if(w.max){v&=(o<=w.max)}if(w.min){v&=(o>=w.min)}return v},message:"Invalid length"},numeric:{validate:function(){return/^\d+$/i.test(this.val())},message:"Numeric only"},email:{validate:function(){return/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/i.test(this.val())},message:"Invalid email"}},fields:[],reconcileFieldOrder:false,haltOnFirstInvalidRule:true,hideMessageContainerOnLoad:true,validateOnFieldChange:true,focusFirstInvalidField:false,ignoreHidden:true,validateSubmit:true,inputSelector:":input[type!=button]",parseMarkup:false,messageElement:"<label />",messageWrap:null,messageContainer:null,messageElementClass:"mv-element-error",messageWrapClass:"mv-wrap-error",inputClass:"mv-input-error",onFieldAdded:null,onFieldValidate:null,onFormValidate:null,onMessagePlacement:null,onInvalidFieldFocus:null},l),s=a(this),j=this,r=0,b=[],d=function(w,v,x){if(f[w]){if(f[w] instanceof Array){for(var o in f[w]){f[w][o].apply(v,x||[])}}else{f[w].apply(v,x||[])}}},m=function(){var y=false;r=0;for(var o in b){if(b[o].isEnabled){var x=true;for(var v in b[o].rules){var w=b[o].rules[v];if(w.isEnabled===false||(f.haltOnFirstInvalidRule&&!Boolean(x))){w.message.hide();continue}x&=(w.isValid!==false);if(w.isValid!==false){b[o].rules[v].message.hide()}else{b[o].rules[v].message.show()}}if((b[o].isValid=Boolean(x))===false){r++;if(b[o].field.is(":input")){b[o].field.addClass(f.inputClass);if(f.focusFirstInvalidField&&!y){d("onInvalidFieldFocus",b[o].field);b[o].field.focus();y=true}}}else{if(b[o].field.is(":input")){b[o].field.removeClass(f.inputClass)}}}}if(f.messageContainer&&r>0){f.messageContainer.show()}else{if(f.messageContainer&&r<=0){f.messageContainer.hide()}}},i=function(w){for(var o in w.rules){var v=w.rules[o];if(f.rules[o]||v.validate){v.message=a(f.messageElement).append(v.message||(f.rules[o]&&f.rules[o].message?f.rules[o].message:"")).addClass(f.messageElementClass);if(f.messageWrap){v.message=a(f.messageWrap).append(v.message).addClass(f.messageWrapClass)}v.message.hide();if(f.onMessagePlacement){d("onMessagePlacement",w.field,v.message)}else{if(v.container){a(v.container).append(v.message)}else{if(f.messageContainer){f.messageContainer.append(v.message)}else{w.field.after(v.message)}}}}}},t=function(v){var o=this;this.field=v.field,this.rules=v.rules,this.isValid=true,this.isEnabled=true;if(v.validateOnChange||f.validateOnFieldChange&&v.validateOnChange!==false){this.field.bind("change",function(){o.Validate();m()})}i(v);d("onFieldAdded",this.field,this)},k=function(w){if(w instanceof Array){for(var v in w){k(w[v])}}else{if(f.reconcileFieldOrder){var o=s.find(f.inputSelector).index(w.field);b.splice((o>-1?o:b.length),0,new t(w))}else{b.push(new t(w))}}},e=function(v){v=(!(v instanceof t)&&v.field===undefined)?{field:v}:v;for(var o in b){if(b[o].field==v.field||b[o].field.attr("id")==v.field.attr("id")){return o}}return -1},u=this.RemoveField=function(w){var v=e(w);if(v>-1){for(var o in b[v].rules){b[v].rules[o].message.remove()}b.splice(v,1)}},g=this.SetFieldEnabled=function(w,o){var v=e(w);if(v>-1){b[v].isEnabled=o}},c=this.SetFieldRuleEnabled=function(y,x,v){var w=e(y);if(w>-1){for(var o in b[w].rules){if(o==x){b[w].rules[o].isEnabled=v;break}}}},p=this.ValidateRule=function(v,o){return(f.rules[v])?f.rules[v].validate(o):false},n=this.ResetState=function(y){if(y==undefined){for(var w in b){b[w].isValid=true;for(var o in b[w].rules){b[w].rules[o].isValid=true}}}else{var v=e(y);if(v>-1){b[v].isValid=true;for(var x in b[v].rules){b[v].rules[x].isValid=true}}}m()},q=this.SetState=function(x){if(x instanceof Array){for(var w in x){q(x[w])}}else{var v=e(x.field);if(v>-1){for(var o in x.rules){if(b[v].rules[o]){b[v].rules[o].isValid=x.rules[o]}}m()}}},h=this.AddMarkupRules=function(o){a(f.inputSelector,o||s).each(function(){var G=a(this),y=this.previousSibling,I={},v=false,E=[];while(y){if(y.nodeType===8){E.splice(0,0,y.nodeValue)}else{if(y.nodeType===1){break}}y=y.previousSibling}for(var B=0;B<E.length;B++){var C=/\s*validate:(\w+)(?:\[\s*(.*)\s*\]\s*)*/i.exec(E[B]);if(C){var w=C[1],J=(C[2])?C[2].split(/\s*\|\s*/):null;if(f.rules[w]){v=true;var A={};for(var D in J){var F=J[D].split(":",2);if(F){var H=F[0],x=F[1].replace(/^['"]|['"]$/ig,"");switch(H){case"container":var z=a(x);if(z.length){A[H]=z}break;case"isValid":A[H]=(x=="true");break;default:A[H]=x;break}}}I[w]=A}}}if(v){j.AddField({field:G,rules:I})}})};t.prototype.Validate=function(){this.isValid=true;if(this.isEnabled&&!(f.ignoreHidden&&!this.field.is(":visible"))){for(var o in this.rules){var v=this.rules[o];if(v.isEnabled!==false){if(f.haltOnFirstInvalidRule&&!this.isValid){break}this.isValid&=v.isValid=(v.validate)?Boolean(v.validate.call(this.field,v)):Boolean(f.rules[o].validate.call(this.field,v))}}if(f.validateOnFieldChange&&f.onFieldValidate){d("onFieldValidate",j,[this,this.isValid])}}return this.isValid};this.Subscribe=function(v,o){if(o instanceof Function){if(f[v] instanceof Array){f[v].push(o)}else{f[v]=(f[v]?[f[v],o]:[o])}return this}return false},this.AddField=function(w){if(w){var v=e(w);if(v>-1&&w.rules!==undefined){for(var o in w.rules){if(b[v].rules[o]){b[v].rules[o].message.remove()}}i(w);b[v].rules=a.extend(true,b[v].rules,w.rules)}else{if(v==-1){k(w)}}m()}},this.GetFieldRules=function(o){var z=[];for(var v in b){if(b[v].isEnabled){if(b[v].field.is(":visible")||o){var y=[];for(var x in b[v].rules){if(b[v].rules[x].isEnabled!==false){var w=[];for(var A in b[v].rules[x]){if(A!="validate"&&A!="message"&&A!="isValid"&&A!="isEnabled"){var B=b[v].rules[x][A];if(B instanceof jQuery){B=B.attr("id")}w.push({key:A,value:B})}}y.push({name:x,properties:w})}}z.push({id:b[v].field.attr("id"),rules:y})}}}return z},this.GetInvalidCount=function(){return r},this.TotalFields=function(){return b.length},this.ClearFields=function(){for(var v in b){for(var o in b[v].rules){b[v].rules[o].message.remove()}}b=[];r=0;m()},this.Validate=function(){var v=true;for(var o in b){v&=b[o].Validate()}m();v=Boolean(v);if(!v){if(f.messageContainer){f.messageContainer.show()}}d("onFormValidate",this,[b,v]);return v};if(f.validateSubmit&&s.is("form")){s.submit(function(o){if(!j.Validate()){o.preventDefault()}})}k(f.fields);if(f.parseMarkup){h()}if(f.hideMessageContainerOnLoad&&f.messageContainer){f.messageContainer.hide()}m();return this}})(jQuery);