(function(t){t.pliantPlugin("inputmask",{options:{masks:{date:{rule:"9{2}/9{2}/9{4}",placeholder:"_",maskOnFocus:!0},url:{rule:"http://*{512}",placeholder:"",maskOnFocus:!1},phone:{rule:"(9{3}) 9{3}-9{4}",placeholder:"_",maskOnFocus:!1},phoneWithExt:{rule:"(9{3}) 9{3}-9{4}? x9{5}",placeholder:"_",maskOnFocus:!1}},definitions:{9:"[0-9]",a:"[A-Za-z]",A:"[A-Za-z0-9]","*":"[A-Za-z0-9_/-]"},resetIncompleteMasks:!0,emptyMaskClass:"plinputmask"},fieldMap:[],getCaret:function(t){var e=null;if(t.setSelectionRange)e={start:t.selectionStart,end:t.selectionEnd};else if(document.selection&&document.selection.createRange){var s=document.selection.createRange();e={start:0-s.duplicate().moveStart("character",-1e5),end:0-s.moveEnd("character",-1e5)}}return e.count=e.start==e.end?1:e.end-e.start,e},setCaret:function(t,e,s){if("number"==typeof e)if(s=s||e,t.setSelectionRange)t.setSelectionRange(e,s),t.focus();else if(t.createTextRange){var i=t.createTextRange();i.collapse(!0),i.moveEnd("character",s),i.moveStart("character",e),i.select()}},parseRule:function(t){for(var e={rule:[],mask:[],string:"",placeholder:t.placeholder,maskOnFocus:t.maskOnFocus,optionalIndex:-1,lastAction:null,onMaskComplete:t.onMaskComplete,onMaskChange:t.onMaskChange},s=t.rule.split(""),i=0;s.length>i;i++)if("{"===s[i]){var a=t.rule.indexOf("}",i);if(a>-1){for(var n=parseInt(t.rule.substring(i+1,a)||1,10),l=0;n-1>l;l++)e.rule.push(RegExp(e.rule[e.rule.length-1])),e.mask.push(t.placeholder);i=a}}else"?"==s[i]?e.optionalIndex=i-1:this.options.definitions[s[i]]?(e.rule.push(RegExp(this.options.definitions[s[i]])),e.mask.push(t.placeholder)):(e.rule.push(null),e.mask.push(s[i]));return e.string=e.mask.join(""),e},match:function(t,e,s){return t.rule[s]?t.rule[s].test(e):!1},removeOptionalMask:function(t,e){if(t.optionalIndex>-1){e=e.split("");for(var s=t.optionalIndex,i=!1;e.length>++s;)e[s]&&e[s]===t.placeholder&&e.splice(s--,1),i=null===t.rule[s];i&&e.splice(t.optionalIndex,e.length-t.optionalIndex),t.field.val(e.join(""))}},applyMask:function(t){var e=t.field.val(),s=t.string.split("");if(e){if(!t.placeholder){for(var i=-1;e.length>i++&&e.charAt(i)===s[i];);e=e.substring(i)}}else t.field.addClass(this.options.emptyMaskClass);this.insert(t,s,e,{start:0,end:0},!1)},findPrev:function(t,e){for(var s=e;s>=0;s--)if(t.rule[s])return s;return-1},findNext:function(t,e,s){for(var i=s;e.length>=i;i++)if(t.rule[i])return i;return-1},shiftRight:function(t,e,s){for(var i=s,a=s,n=t.placeholder||"";t.mask.length>i&&a>-1;i++)if(t.rule[i]){a=this.findNext(t,e,i+1);var l=e[i];if(e[i]=n,void 0!==l&&!this.match(t,l,a))break;n=l}},shiftLeft:function(t,e,s,i){for(var a=s,n=this.findNext(t,e,i);t.mask.length>a&&n>-1;a++)if(t.rule[a]){if(!this.match(t,e[n],a))break;e[a]=e[n],e[n]=t.placeholder,n=this.findNext(t,e,n+1)}},insert:function(t,e,s,i,a){var n=i||this.getCaret(t.field[0]),l=s.split("");if(t.rule.length>n.start){n.start!==n.end&&(this.remove(t,e,n.start,n.end),n.count>1&&this.shiftLeft(t,e,n.start+1,n.end));for(var r=0,o=this.findNext(t,e,n.start);l.length>r&&o>-1;r++)this.match(t,l[r],o)&&(this.shiftRight(t,e,o),e[o]=l[r],o=this.findNext(t,e,o+1));this.writeOut(t,e,a?o>-1?o:n.start+1:null)}},remove:function(t,e,s,i){for(var a=s;i>a&&e.length>a;a++)t.rule[a]&&(e[a]=t.placeholder)},writeOut:function(t,e,s,i){t.field.val(e.join("")),null!==s&&(this.setCaret(t.field[0],s,i),t.onMaskChange&&t.onMaskChange.call(t.field),t.onMaskComplete&&s>=e.length&&t.onMaskComplete.call(t.field))},findEndInputIndex:function(t,e){for(var s=e.split(""),i=t.mask.length,a=i-1;a>0;a--)if(t.mask[a]!==s[a]&&t.rule[a])return i>a+1?a+1:t.mask.length;return 0},onFieldAdded:function(e){var s=e.mask||e.field.attr("mask");if(s&&"password"!==e.field.attr("type")&&this.options.masks[s]){var i=this.parseRule(this.options.masks[s]);i.field=e.field,e.field.on("keypress.mvinputmask",t.proxy(function(e){var s=t(e.target);return!e.ctrlKey&&!e.altKey&&!e.metaKey&&e.which>=32?(this.insert(i,s.val().split(""),String.fromCharCode(e.which),null,!0),!1):(13===e.which&&s.blur(),void 0)},this)).on("keydown.mvinputmask",t.proxy(function(e){var s=e.target,a=this.getCaret(s),n=t(s).val().split("");return 8==e.which&&a.start===a.end&&a.start-1>=0?(a.start=this.findPrev(i,a.start-1),a.start>-1&&(this.remove(i,n,a.start,a.end),this.shiftLeft(i,n,a.start,a.end),this.writeOut(i,n,a.start)),!1):46==e.which&&i.mask.length-1>=a.start||8==e.which&&a.start!==a.end?(a.start=this.findNext(i,n,a.start),a.start>a.end&&(a.end+=a.start-a.end+1),a.end=a.start===a.end?a.end+1:a.end,this.remove(i,n,a.start,a.end),this.shiftLeft(i,n,a.start,a.end),this.writeOut(i,n,a.start),!1):void 0},this)).on("paste.mvinputmask",t.proxy(function(e){var s=t(e.target),a=s.val().split(""),n=this.getCaret(s[0]);return i.mask.length>n.start?(s.val(""),setTimeout(t.proxy(function(){this.insert(i,a,s.val(),n,!0),i.lastAction="p"},this),0),void 0):!1},this)).on("cut.mvinputmask",function(){return!1}).on("focus.mvinputmask",t.proxy(function(e){this.applyMask(i);var s=t(e.target).removeClass(this.options.emptyMaskClass),a=i.prevVal=s.val(),n=i.placeholder?this.findEndInputIndex(i,a):a.length;n>-1&&setTimeout(t.proxy(function(){this.setCaret(s[0],n)},this),0)},this)).on("blur.mvinputmask",t.proxy(function(e){var s=t(e.target),a=s.val(),n=a?a.indexOf(i.placeholder):-1;a&&(i.maskOnFocus&&(a===i.string||i.placeholder&&n>-1)?s.val(""):i.placeholder&&this.options.resetIncompleteMasks&&n>-1&&(-1==i.optionalIndex||i.optionalIndex>n)&&s.val(i.string)),a=s.val(),i.optionalIndex>-1&&n>i.optionalIndex&&this.removeOptionalMask(i,a),i.lastAction&&"p"===i.lastAction||(i.lastAction=null,(i.maskOnFocus&&(a&&a!==i.prevVal||!a&&i.prevVal!==i.string)||!i.maskOnFocus&&(a!==i.prevVal||a!==i.string))&&s.removeClass(this.options.emptyMaskClass).trigger("change")),a===i.string&&s.addClass(this.options.emptyMaskClass)},this)).on("change.mvinputmask",t.proxy(function(s){var a=t(s.target).val();a===i.string?e.field.addClass(this.options.emptyMaskClass):(e.field.removeClass(this.options.emptyMaskClass),i.optionalIndex>-1&&a!==i.string&&this.removeOptionalMask(i,e.field.val()))},this));var a=t.trim(e.field.val());(!i.maskOnFocus||a.length>0)&&(this.applyMask(i),a.length>0&&(a===i.string&&e.field.addClass(this.options.emptyMaskClass),i.optionalIndex>-1&&a!==i.string&&this.removeOptionalMask(i,e.field.val()))),this.fieldMap.push(i)}},onPreFieldValidate:function(t){for(var e=0;this.fieldMap.length>e;e++)this.fieldMap[e].mask&&this.fieldMap[e].field[0]===t.field[0]&&(t.field.val()===this.fieldMap[e].string?t.field.val("").removeClass(this.options.emptyMaskClass):this.fieldMap[e].optionalIndex>-1&&this.removeOptionalMask(this.fieldMap[e],t.field.val()))},onPostFieldValidate:function(t){for(var e=0;this.fieldMap.length>e;e++)this.fieldMap[e].mask&&this.fieldMap[e].field[0]===t.field[0]&&0===t.field.val().length&&!this.fieldMap[e].maskOnFocus&&t.field.val(this.fieldMap[e].string).addClass(this.options.emptyMaskClass)},onFieldRemoved:function(t){if(t.field.hasClass(this.options.emptyMaskClass)){t.field.removeClass(this.options.emptyMaskClass).off(".mvinputmask").val("");for(var e,s=0;this.fieldMap.length>s;s++)if(this.fieldMap[s].field[0]===t.field[0]){e=s;break}e&&this.fieldMap.splice(e,1)}},ClearMasks:function(){for(var e=0;this.fieldMap.length>e;e++)t.trim(this.fieldMap[e].field.val())===this.fieldMap[e].string&&this.fieldMap[e].field.val("")},onReady:function(){this.instance.ClearMasks=t.proxy(this.ClearMasks,this)}})})(jQuery);