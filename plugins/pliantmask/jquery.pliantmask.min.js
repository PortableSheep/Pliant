(function(e){e.fn.pliantmask=function(t){var a=e.extend(!0,{masks:{date:{rule:"9{2}/9{2}/9{4}",placeholder:"_",maskOnFocus:!0},url:{rule:"http://*{512}",placeholder:"",maskOnFocus:!1},phone:{rule:"(9{3}) 9{3}-9{4}",placeholder:"_",maskOnFocus:!1},phoneWithExt:{rule:"(9{3}) 9{3}-9{4}? x9{5}",placeholder:"_",maskOnFocus:!1}},definitions:{9:"[0-9]",a:"[A-Za-z]",A:"[A-Za-z0-9]","*":"[A-Za-z0-9_/-]"},resetIncompleteMasks:!0,emptyMaskClass:"input-mask",fields:[],inputSelector:':input[type="text"]'},t),n=[],s=function(e){var t=null;if(e.setSelectionRange)t={start:e.selectionStart,end:e.selectionEnd};else if(document.selection&&document.selection.createRange){var a=document.selection.createRange();t={start:0-a.duplicate().moveStart("character",-1e5),end:0-a.moveEnd("character",-1e5)}}return t.count=t.start==t.end?1:t.end-t.start,t},l=function(e,t,a){if("number"==typeof t)if(a=a||t,e.setSelectionRange)e.setSelectionRange(t,a),e.focus();else if(e.createTextRange){var n=e.createTextRange();n.collapse(!0),n.moveEnd("character",a),n.moveStart("character",t),n.select()}},r=function(e){for(var t={rule:[],mask:[],string:"",placeholder:e.placeholder,maskOnFocus:e.maskOnFocus,optionalIndex:-1,lastAction:null,onMaskComplete:e.onMaskComplete,onMaskChange:e.onMaskChange},n=e.rule.split(""),s=0;n.length>s;s++)if("{"===n[s]){var l=e.rule.indexOf("}",s);if(l>-1){for(var r=parseInt(e.rule.substring(s+1,l)||1,10),i=0;r-1>i;i++)t.rule.push(RegExp(t.rule[t.rule.length-1])),t.mask.push(e.placeholder);s=l}}else"?"==n[s]?t.optionalIndex=s-1:a.definitions[n[s]]?(t.rule.push(RegExp(a.definitions[n[s]])),t.mask.push(e.placeholder)):(t.rule.push(null),t.mask.push(n[s]));return t.string=t.mask.join(""),t},i=function(e,t,a){return e.rule[a]?e.rule[a].test(t):!1},o=function(e,t){if(e.optionalIndex>-1){t=t.split("");for(var a=e.optionalIndex,n=!1;++a<t.length;)t[a]&&t[a]===e.placeholder&&t.splice(a--,1),n=null===e.rule[a];n&&t.splice(e.optionalIndex,t.length-e.optionalIndex),e.field.val(t.join(""))}},u=function(e){var t=e.field.val(),n=e.string.split("");if(t){if(!e.placeholder){for(var s=-1;s++<t.length&&t.charAt(s)===n[s];);t=t.substring(s)}}else e.field.addClass(a.emptyMaskClass);h(e,n,t,{start:0,end:0},!1)},c=function(e,t){for(var a=t;a>=0;a--)if(e.rule[a])return a;return-1},p=function(e,t,a){for(var n=a;t.length>=n;n++)if(e.rule[n])return n;return-1},f=function(e,t,a){for(var n=a,s=a,l=e.placeholder||"";e.mask.length>n&&s>-1;n++)if(e.rule[n]){s=p(e,t,n+1);var r=t[n];if(t[n]=l,void 0!==r&&!i(e,r,s))break;l=r}},d=function(e,t,a,n){for(var s=a,l=p(e,t,n);e.mask.length>s&&l>-1;s++)if(e.rule[s]){if(!i(e,t[l],s))break;t[s]=t[l],t[l]=e.placeholder,l=p(e,t,l+1)}},h=function(e,t,a,n,l){var r=n||s(e.field[0]),o=a.split("");if(r.start<e.rule.length){r.start!==r.end&&(m(e,t,r.start,r.end),r.count>1&&d(e,t,r.start+1,r.end));for(var u=0,c=p(e,t,r.start);o.length>u&&c>-1;u++)i(e,o[u],c)&&(f(e,t,c),t[c]=o[u],c=p(e,t,c+1));v(e,t,l?c>-1?c:r.start+1:null)}},m=function(e,t,a,n){for(var s=a;n>s&&t.length>s;s++)e.rule[s]&&(t[s]=e.placeholder)},v=function(e,t,a,n){e.field.val(t.join("")),null!==a&&(l(e.field[0],a,n),e.onMaskChange&&e.onMaskChange.call(e.field),e.onMaskComplete&&a>=t.length&&e.onMaskComplete.call(e.field))},k=function(e,t){for(var a=t.split(""),n=e.mask.length,s=n-1;s>0;s--)if(e.mask[s]!==a[s]&&e.rule[s])return n>s+1?s+1:e.mask.length;return 0},g=function(){for(var t in n)e.trim(n[t].field.val())===n[t].string&&n[t].field.val("")},x=function(t,i){if(i=e.isPlainObject(i)?i:a.masks[i],t instanceof jQuery||(t=e(t)),1==t.length&&i&&"password"!==t.attr("type")){var f=r(e.extend({placeholder:"_",maskOnFocus:!1},i));f.field=t,t.on("keypress.plinputmask",e.proxy(function(t){var a=e(t.target);return!t.ctrlKey&&!t.altKey&&!t.metaKey&&t.which>=32?(h(f,a.val().split(""),String.fromCharCode(t.which),null,!0),!1):(13===t.which&&a.blur(),void 0)},this)).on("keydown.plinputmask",e.proxy(function(t){var a=t.target,n=s(a),l=e(a).val().split("");return 8==t.which&&n.start===n.end&&n.start-1>=0?(n.start=c(f,n.start-1),n.start>-1&&(m(f,l,n.start,n.end),d(f,l,n.start,n.end),v(f,l,n.start)),!1):46==t.which&&n.start<=f.mask.length-1||8==t.which&&n.start!==n.end?(n.start=p(f,l,n.start),n.start>n.end&&(n.end+=n.start-n.end+1),n.end=n.start===n.end?n.end+1:n.end,m(f,l,n.start,n.end),d(f,l,n.start,n.end),v(f,l,n.start),!1):void 0},this)).on("paste.plinputmask",e.proxy(function(t){var a=e(t.target),n=a.val().split(""),l=s(a[0]);return l.start<f.mask.length?(a.val(""),setTimeout(function(){h(f,n,a.val(),l,!0),f.lastAction="p"},0),void 0):!1},this)).on("cut.plinputmask",function(){return!1}).on("focus.plinputmask",e.proxy(function(t){u(f);var n=e(t.target).removeClass(a.emptyMaskClass),s=f.prevVal=n.val(),r=f.placeholder?k(f,s):s.length;r>-1&&setTimeout(function(){l(n[0],r)},10)},this)).on("blur.plinputmask",e.proxy(function(t){var n=e(t.target),s=n.val(),l=s?s.indexOf(f.placeholder):-1;s&&(f.maskOnFocus&&(s===f.string||f.placeholder&&l>-1)?n.val(""):f.placeholder&&a.resetIncompleteMasks&&l>-1&&(-1==f.optionalIndex||f.optionalIndex>l)&&n.val(f.string)),s=n.val(),f.optionalIndex>-1&&l>f.optionalIndex&&o(f,s),f.lastAction&&"p"===f.lastAction||(f.lastAction=null,(f.maskOnFocus&&(s&&s!==f.prevVal||!s&&f.prevVal!==f.string)||!f.maskOnFocus&&(s!==f.prevVal||s!==f.string))&&n.removeClass(a.emptyMaskClass).trigger("change")),s===f.string&&n.addClass(a.emptyMaskClass)},this)).on("change.plinputmask",e.proxy(function(n){var s=e(n.target).val();s===f.string?t.addClass(a.emptyMaskClass):(t.removeClass(a.emptyMaskClass),f.optionalIndex>-1&&s!==f.string&&o(f,t.val()))},this)).on("mouseup.plinputmask",e.proxy(function(t){setTimeout(e.proxy(function(){var a=e(t.target);0==a.val().length&&a.focus()},this),0)},this));var g=e.trim(t.val());(!f.maskOnFocus||g.length>0)&&(u(f),g.length>0&&(g===f.string&&t.addClass(a.emptyMaskClass),f.optionalIndex>-1&&g!==f.string&&o(f,t.val()))),n.push(f)}else for(var x=0;n.length>x;x++)if(n[x].field[0]===t[0]&&n[x].mask&&!n[x].maskOnFocus){u(n[x]);break}},C=function(e){if(e.hasClass(a.emptyMaskClass)){e.removeClass(a.emptyMaskClass).off(".plinputmask").val("");for(var t,s=0;n.length>s;s++)if(n[s].field[0]===e[0]){t=s;break}t&&n.splice(t,1)}},y=function(e){for(var t=0;n.length>t;t++)n[t].mask&&n[t].field[0]===e[0]&&(e.val()===n[t].string?e.val("").removeClass(a.emptyMaskClass):n[t].optionalIndex>-1&&o(n[t],e.val()))};this.Clear=g,this.Mask=function(e,t){var t=t||e.attr("mask");x(e,t)},this.RemoveMask=C,this.UnMask=y;for(var M in a.fields)x(a.fields[M].field,a.fields[M].mask);return this.find(a.inputSelector).each(function(){(mask=e(this).attr("mask"))&&x(this,mask)}),this}})(jQuery);